<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è¥¿é‡ã²ã‹ã‚Š Reï¼šãƒãƒ£ãƒƒãƒˆ</title>
  <link rel="stylesheet" href="styles/chat-style.css">
</head>

<body>
  <!-- ãƒˆãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div style="padding: 20px; background-color: #f0f0f0; text-align: center;">
    <h2>ã“ã‚Œã¯ã€ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™ã€‚</h2>
    <p>å³ä¸‹ã®ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰è¥¿é‡ã²ã‹ã‚Š Reï¼šã¨ãŠè©±ã—ã§ãã¾ã™ã€‚</p>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆUI -->
  <button id="chat-button">ğŸ’¬</button>

  <div id="chat-box">
    <div id="chat-log"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
      <button id="chat-send">é€ä¿¡</button>
    </div>
  </div>

  <script>
    const chatButton = document.getElementById('chat-button');
    const chatBox = document.getElementById('chat-box');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    const avatarMap = {
      "å–œ": "images/hikari_happy.png",
      "æ€’": "images/hikari_angry.png",
      "å“€": "images/hikari_sad.png",
      "æ¥½": "images/hikari_neutral.png"
    };

    function addBotMessage(text, emotion = "æ¥½") {
      const botMsg = document.createElement('div');
      botMsg.className = 'bot-message';

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = avatarMap[emotion] || avatarMap["æ¥½"];

      const botBubble = document.createElement('div');
      botBubble.className = 'message-bubble bot-bubble';
      botBubble.textContent = text;

      botMsg.appendChild(avatar);
      botMsg.appendChild(botBubble);
      chatLog.appendChild(botMsg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function parseGPTResponse(text) {
      const emotionMatch = text.match(/æ„Ÿæƒ…[:ï¼š]?\s*(å–œ|æ€’|å“€|æ¥½)/);
      const responseMatch = text.match(/å¿œç­”[:ï¼š]?\s*(.+)/s);

      const emotion = emotionMatch ? emotionMatch[1] : "æ¥½";
      const reply = responseMatch ? responseMatch[1].trim() : "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã†ã¾ãå¿œç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

      const validEmotions = ["å–œ", "æ€’", "å“€", "æ¥½"];
      const safeEmotion = validEmotions.includes(emotion) ? emotion : "æ¥½";

      return { emotion: safeEmotion, reply };
    }

    window.addEventListener("load", () => {
      chatBox.style.display = 'flex';
      addBotMessage("ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯è¥¿é‡ã²ã‹ã‚Š Reï¼šã§ã™ã€‚ä½•ã‹ãŠå›°ã‚Šã”ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "æ¥½");
    });

    chatButton.addEventListener('click', () => {
      chatBox.style.display = chatBox.style.display === 'none' ? 'flex' : 'none';
    });

    chatSend.addEventListener('click', async () => {
      const userInput = chatInput.value.trim();
      if (!userInput) return;

      const userMsg = document.createElement('div');
      userMsg.className = 'user-message';
      const userBubble = document.createElement('div');
      userBubble.className = 'message-bubble user-bubble';
      userBubble.textContent = userInput;
      userMsg.appendChild(userBubble);
      chatLog.appendChild(userMsg);
      chatInput.value = '';
      chatLog.scrollTop = chatLog.scrollHeight;

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ userInput })
        });

        const data = await response.json();
        if (data && data.content) {
          const parsed = parseGPTResponse(data.content);
          addBotMessage(parsed.reply, parsed.emotion);
        } else {
          addBotMessage("ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€å¿œç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", "å“€");
        }
      } catch (error) {
        addBotMessage("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚", "å“€");
      }
    });
  </script>
</body>
</html>
